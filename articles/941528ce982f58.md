---
title: "nuqsã§URLSearchParamsã‚’å…‹æœã™ã‚‹"
emoji: "ğŸ‘Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [React, Next.js, TypeScript, nuqs]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€‚çªç„¶ã§ã™ãŒã€[URLSearchParams](https://developer.mozilla.org/ja/docs/Web/API/URLSearchParams)ã‚’ä½¿ã£ã¦ã„ã¦å‹ã®æ‰±ã„ã«è‹¦åŠ´ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿç§ã¯ã‚ã‚Šã¾ã™ã€‚å‹ã®å®‰å…¨æ€§ãŒå¼±ã„ã‚“ã§ã™ã€‚

æœ€è¿‘ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã§ã¯ã€å‹ãªã—ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã¯ã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã‚ˆã­ã€‚ã‚€ã—ã‚å‹ãŒãªã„ã¨å¼·çƒˆãªä¸å®‰ã«è¥²ã‚ã‚Œã‚‹ã“ã¨ã‚‚ã—ã°ã—ã°ã€‚

```ts
const res = fetchSome() // res is any ğŸ¤®ğŸ¤®ğŸ¤®
```

ã ã‹ã‚‰ã€å‹ãŒãªããªã‚‹ã“ã¨ã¯æœ€å¤§é™é¿ã‘ãŸã„ã¯ãšã§ã™ã€‚ã˜ã‚ƒã‚ã€å‹ãŒãªããªã£ã¦ã—ã¾ã†è¦å› ã£ã¦ä½•ã§ã—ã‚‡ã†ï¼Ÿè€ƒãˆã‚‰ã‚Œã‚‹è¦å› ã¯ãŸãã•ã‚“ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªWebé–‹ç™ºã®æ–‡è„ˆã§ã¯å¤–éƒ¨ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹ã¨ããŒå¤šã„ã§ã™ã­ã€‚

ã¾ãšæ€ã„ã¤ãã®ã¯Web APIã®å‹ã§ã™ã€‚ã§ã‚‚ã€OpenAPIã‚’ã¯ã˜ã‚ã¨ã™ã‚‹APIã®Schemaå®šç¾©æ‰‹æ³•ãŒç¢ºç«‹ã•ã‚Œã€ãƒã‚¦ãƒã‚¦ãŒæºœã¾ã£ã¦ããŸãŠã‹ã’ã§ã€å‹ã®é¢ã§ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã‚‹ã“ã¨ã¯å°‘ãªããªã£ã¦ãã¾ã—ãŸã€‚ã˜ã‚ƒã‚æ¬¡ã«å‹ã‚’å¤±ã†ã‚ˆã†ãªåŸå› ã¯ä½•ã‹ã€‚ãã†ã€URLSearchParamsã§ã™ã€‚

```ts
// /path/?count=10
const searchParams = new URLSearchParams(location.search)
const count = searchParams.get("count")
    // ^ string | null ğŸ¤®ğŸ¤®ğŸ¤®
```

URLSearchParamsã¯å‹ã®ã‚µãƒãƒ¼ãƒˆãŒå¼±ã„ä¸Šã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«å…¥åŠ›ã§ãã‚‹æ€§è³ªä¸Šã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒé »ç™ºã—ã¾ã™ã€‚ãã®ä¸Šã€å–ã‚Šå›ã—ã‚‚é›£ã—ã„ã§ã™ã€‚

**ã‚±ãƒ¼ã‚¹1. å…¨ã¦æ–‡å­—åˆ—å‹ã«ã‚­ãƒ£ã‚¹ãƒˆã•ã‚Œã‚‹**
```tsx
searchParams.set("count", 10) // ?count=10
count = searchParams.get("count") // => "10" æ–‡å­—åˆ—ã«ãªã£ã¦ã‚‹ ğŸ¤®
```

**ã‚±ãƒ¼ã‚¹2. ä¸å®Œå…¨ãªã‚±ãƒ¼ã‚¹ãŒäºˆæœŸã—ã¥ã‚‰ã„**
```tsx
// path/?name=
searchParams.get("name") // => "" ã¨ null ã©ã£ã¡ã ã£ã‘...ğŸ¤”
```

**ã‚±ãƒ¼ã‚¹3. æ¶ˆã—æ–¹ã‚’é–“é•ãˆã‚„ã™ã„**
```tsx
searchParams.set("others", null) // ?others=null           ğŸ¤®
searchParams.set("others", undefined) // ?others=undefined ğŸ¤®
searchParams.set("others", "") // ?others=                 ğŸ¤®

searchParams.delete("others") // æ­£ã—ã„ ğŸ™†â€â™‚ï¸
```

ã•ã‚‰ã«ã€React Server Componentsã®æ™®åŠã«ä¼´ã£ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼é–“ã®çŠ¶æ…‹å…±æœ‰ã®æ‰‹æ³•ã¨ã—ã¦æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½¿ç”¨é »åº¦ãŒé«˜ããªã£ã¦ãã¦ã„ã¾ã™ã€‚æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹ã®å¼·åŒ–ãŒæœ›ã¾ã‚Œã‚‹æ©Ÿé‹ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã‚“ã§ã™ã€‚

å‰ç½®ããŒé•·ããªã£ã¡ã‚ƒã„ã¾ã—ãŸãŒã€ã“ã‚Œã‚‰ã®æ‚©ã¿ã€nuqsã‚’ä½¿ãˆã°å…¨éƒ¨è§£æ±ºã§ãã¾ã™ï¼

https://nuqs.47ng.com/

## nuqsã¨ã¯
nuqsã¯Next.jsã®æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ä¸€ç•ªåŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ãªçŠ¶æ…‹ã¨æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã®åŒæœŸã§ã™ã€‚

### æ§‹æ–‡
useQueryStateã¨ã„ã†useStateã«ä¼¼ãŸæ§‹æ–‡ã§çŠ¶æ…‹ã‚’å®£è¨€ã€æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```tsx
const [name, setName] = useQueryState("name")
```
URLã‚’è¦‹ã‚‹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®£è¨€ã—ãŸçŠ¶æ…‹ãŒå¸¸ã«æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸åæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚åŒæœŸã®éš›ã«ã¯`useQueryState`ã«æ¸¡ã—ãŸ"name"ãŒã‚­ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

![](/images/941528ce982f58/01-bind-url.gif)

### æ–‡å­—åˆ—ä»¥å¤–ã®å‹ã«å¤‰æ›
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ–‡å­—åˆ—å‹ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ãŒã€ç¬¬äºŒå¼•æ•°ã«nuqsãŒç”¨æ„ã—ãŸparserã‚’æ¸¡ã›ã°æ•°å€¤ã‚„boolå€¤ã€é…åˆ—ãªã©åŸºæœ¬çš„ãªå‹ã¸ã®å¤‰æ›ã‚‚å¯èƒ½ã§ã™ã€‚
```tsx
import { parseAsString, parseAsInteger, parseAsBoolean, parseAsArray } from 'nuqs'

// /?count=1&isPublic=true&tags=hoge,fuga
const [count, setCount] = useQueryState("count", parseAsInteger) // count is 1
const [isPublic, setIsPublic] = useQueryState("isPublic", parseAsBoolean) // isPublic is true
const [tags, setTags] = useQueryState("tags", parseAsArrayOf(parseAsString)) // tags is ["hoge", "fuga"]
```

### åˆæœŸå€¤ã®æŒ‡å®š
keyãŒå­˜åœ¨ã—ãªã„å ´åˆã‚„parseä¸å¯èƒ½ãªå ´åˆã¯`null`ã‚’è¿”ã—ã¾ã™ãŒã€ä»»æ„ã®åˆæœŸå€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã€åˆæœŸå€¤ã¯URLã«ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚

```tsx
// /?name=
const [name, setName] = useQueryState("name", parseAsString.withDefault("")); // name is "" ã€‚å‹ä¸Šã‚‚ string ã®ã¿ã«ãªã‚‹
```

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‰Šé™¤
`null`ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```tsx
// path is /?name=aaa
const [name, setName] = useQueryState("name", parseAsString.withDefault(""));
setName(null)

// path is /
// name is ""
```

---

ã“ã‚Œã ã‘ã§ã‚‚å¾“æ¥searchParamsã‚’ãã¡ã‚ƒãã¡ã‚ƒæ›¸ã„ã¦ã„ãŸç®‡æ‰€ãŒã‚¹ãƒƒã‚­ãƒªã™ã‚‹ä¸Šã«ã€è‡ªç„¶ã¨å‹å®‰å…¨ã«ãªã‚Šã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“nuqsã®è‰¯ã•ã¯ã“ã‚Œã ã‘ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚
ç¶šã„ã¦ç§ã®æ¨ã—ãƒã‚¤ãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ï¼

## æ¨ã—1. æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã®ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã‚’ä½¿ãˆã‚‹
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã§ã¯ã€ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã¯ã»ã¼å¿…é ˆã§ã™ã‚ˆã­ã€‚ä¾‹ãˆã°ã€Œæ€§åˆ¥ã€ã®ã‚ˆã†ã«äºˆã‚å®šã‚ãŸå€¤ã—ã‹å–ã‚Šãˆãªã„ã‚‚ã®ã‚’æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç®¡ç†ã—ãŸã„å ´åˆã€å¾“æ¥ã®æ–¹æ³•ã§ã¯å€¤ã®å‹ãŒ`string`ã«ãƒ¯ã‚¤ãƒ‰ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã—ã¾ã„ã€å‹å®‰å…¨æ€§ãŒå¤±ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚
ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒURLã«ä»»æ„ã®å€¤ã‚’å…¥åŠ›ã—ãŸå ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚é¢å€’ã§ã—ãŸã€‚

nuqsã‚’ä½¿ãˆã°ã“ã‚Œã‚‰ã®å•é¡ŒãŒè§£æ±ºã—ã¾ã™ã€‚æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã®ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã‚’ä½¿ã£ã¦ã€å‹å®‰å…¨ã‹ã¤ç°¡å˜ã«å€¤ã‚’ç®¡ç†ã§ãã‚‹ã‚“ã§ã™ã€‚

ç”·ã€å¥³ã€ãã®ä»–ã‹ã‚‰æ€§åˆ¥ã‚’é¸æŠã™ã‚‹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ä¾‹ã§è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](/images/941528ce982f58/02-gender.gif)

```tsx
const genderOptions = ["ç”·", "å¥³", "ãã®ä»–"] as const;
type Gender = (typeof genderOptions)[number];

// gender ã¯ "ç”·" | "å¥³" | "ãã®ä»–" | null ã—ã‹å–ã‚Šãˆãªã„ã€‚
const [gender, setGender] = useQueryState("gender", parseAsStringLiteral(genderOptions));

return (
  <>
    <p>ä»Šé¸æŠã•ã‚Œã¦ã„ã‚‹ gender: {gender}</p>
    <select
      value={gender ?? ""}
      onChange={(e) => setGender(e.target.value as Gender)}
    >
      <option value="">æ€§åˆ¥ã‚’é¸æŠ</option>
      {genderOptions.map((option) => (
        <option key={option} value={option}>
          {option}
        </option>
      ))}
    </select>
  </>
);
```

## æ¨ã—2. Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŒå‹å®‰å…¨ã«
Next.jsã®Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§hrefå±æ€§ã«æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹éš›ã€ã‚­ãƒ¼ã®åå‰ã‚„å€¤ã®å‹ãŒæ­£ã—ã„ã‹å¿ƒé…ã«ãªã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

```tsx
// keyã‚’typoã—ã¦ã„ãªã„ã‹?å€¤ã¯ä¿¡ç”¨ã§ãã‚‹ã®ã‹?
<Link href={`/path?search=${search}&cnt=${count}sortBy=${sortBy}`}>ãƒªãƒ³ã‚¯</Link>
```

nuqsã§ã¯äºˆã‚ã€searchParamsã®schemaã‚’å®šç¾©ã§ãã‚‹ã®ã§ã€ã“ã®ã‚ˆã†ãªå¿ƒé…ã‚’ã—ãªãã¦æ¸ˆã¿ã¾ã™ã€‚

```tsx:schema.ts
import Link from "next/link";
import {
  createSerializer,
  parseAsInteger,
  parseAsString,
  parseAsStringLiteral,
} from "nuqs";

const searchParamsSchema = {
  search: parseAsString,
  count: parseAsInteger.withDefault(10),
  sortBy: parseAsStringLiteral(["asc", "desc"] as const),
};
const serialize = createSerializer(searchParamsSchema);
```

```tsx
// cnt ã¯å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§tsã‚¨ãƒ©ãƒ¼
// sortBy ã¯schemaã¨ç•°ãªã‚‹å€¤ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã®ã§tsã‚¨ãƒ©ãƒ¼
<Link href={serialize({ search: "foo", cnt: 20, sortBy: "time" })}>ãƒªãƒ³ã‚¯</Link>

serialize({ search: "foo", count: 20, sortBy: "asc" })
// search=foo&count=20&sortBy=asc
```

## æ¨ã—3. ã‚µãƒ¼ãƒãƒ¼ã¨ã®åŒæœŸãŒç°¡å˜ã‹ã¤æŸ”è»Ÿã«
æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼é–“ã§å…±æœ‰ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‚ˆã­ã€‚å¾“æ¥ã®æ–¹æ³•ã§ã¯ã€æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ãŸå¾Œã«router.refresh()ã§ã‚µãƒ¼ãƒãƒ¼ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¿ƒã™å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

nuqsã§ã¯`withOption`ã«`shallow: false`ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã€è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒãƒ¼ã¨ã®åŒæœŸã‚’è¡Œãˆã¾ã™ã€‚ã•ã‚‰ã«ã€throttleã®è¨­å®šã‚‚å¯èƒ½ãªã®ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ã‚‚ç°¡å˜ã§ã™ã€‚

![](/images/941528ce982f58/03-shallow-true.gif)

```tsx:client.tsx
// client component
export function Client() {
  const [search, setSearch] = useQueryState(
    "search",
    parseAsString.withDefault("").withOptions({ shallow: true }),
  );

  return (
    <input value={search} onChange={(e) => setSearch(e.target.value)} />
  );
}
```

```tsx:page.tsx
export default function Page({
  searchParams,
}: { searchParams: Record<string, string | string[] | undefined> }) {
  return (
    <div>
      server: {JSON.stringify(searchParams)}
      <Client />
    </div>
  );
}
```

:::details shallow false(default) ã®å ´åˆ
![](/images/941528ce982f58/04-shallow-false.gif)
:::

throttleã¯`throttleMs`ã§æŒ‡å®šã§ãã¾ã™ã€‚
```tsx
useQueryState(
  "search",
  parseAsString.withDefault("").withOptions({ shallow: true, throttleMs: 1000 }),
);
```

## æ¨ã—4. ãƒã‚¹ãƒˆã—ãŸServer Componentsã§ SearchParamsã‚’å–å¾—ã§ãã‚‹
å¾“æ¥ã§ã‚ã‚Œã°ã€ãƒã‚¹ãƒˆã—ãŸServer Componentsã§ã¯SearchParamsã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ããšã€ãƒ«ãƒ¼ãƒˆã®Pageã‹ã‚‰ãƒã‚±ãƒ„ãƒªãƒ¬ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚ŒãŒã‹ãªã‚Šé¢å€’ã ã£ãŸã®ã§ã™ãŒã€nuqsã§ã¯rootã§SearchParamsã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€æœ«ç«¯ã®Server Componentsã§ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†åˆ©ç”¨ã™ã‚‹å½¢ã§SearchParamsã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```tsx:search-params.tsx
// searchParamsã®schemaã‚’ä½œæˆ
import { parseAsString } from "nuqs";
import { createSearchParamsCache } from "nuqs/parsers";

export const searchParamsCache = createSearchParamsCache({
  search: parseAsString.withDefault(""),
});
```

```tsx:page.tsx
// ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒˆã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
export default function Page({
  searchParams,
}: { searchParams: Record<string, string | string[] | undefined> }) {
  searchParamsCache.parse(searchParams);
  return (
    <div>
      <NestServer />
    </div>
  );
}
```

```tsx:nest-server.tsx
// æœ«ç«¯ã®server componentã§ã‚‚å–å¾—ã§ãã‚‹
export const NestServer = () => {
  const searchParams = searchParamsCache.all();
  return <div>{searchParams.search}</div>;
};
```

## ã¾ã¨ã‚
ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿnuqsã‚’ä½¿ãˆã°ã€URLSearchParamsã®å‹å®‰å…¨æ€§ã®å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã ã‘ã§ãªãã€é–‹ç™ºåŠ¹ç‡ã‚‚å¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚[ãƒ†ã‚¹ãƒˆä½“é¨“](https://nuqs.47ng.com/docs/testing)ã‚„[ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼](https://github.com/47ng/nuqs/discussions/446)ãªã©ã€ã¾ã æ”¹å–„ã®ä½™åœ°ã¯ã‚ã‚Šã¾ã™ãŒã€nuqsã¯æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ‰±ã„ã‚’åŠ‡çš„ã«æ”¹å–„ã—ã¦ãã‚Œã¾ã™ã€‚

å‹å®‰å…¨ãªä¸–ç•Œã‚’ç›®æŒ‡ã—ã¦ã€nuqsã‚’ä½¿ã£ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ

https://nuqs.47ng.com/